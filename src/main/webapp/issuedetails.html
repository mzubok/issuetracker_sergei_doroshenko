<!DOCTYPE html>
<html>
     <head>
             <meta charset="UTF-8">
             <title>Issue Delails</title>
             <link rel="stylesheet" type="text/css" media="screen" href="css/default.css" />
             <script type="text/javascript" src="js/jquery-1.9.0.min.js"> </script>
             <script type="text/javascript" src="js/login.js"> </script>
     </head>
     <body>
        <div class="page-wrapper">
             <div class="header">
                <div class="logo">
                        <h2>Issue Tracker</h2>
                </div><!--end logo-->
                <div id="user-info" class="user-info">
                        <div id="error"></div>
         <form id="auth-form">
             <label>Name:</label>
             <input name="login" id="login" class="login" type="text" value="My name"/>
             <label>Password:</label>
             <input name="password" id="password" class="password" type="password" />
             <input id="authsubmit" class="authsubmit" type="submit" value="Log in" />
         </form>
                     </div><!--end user-info-->
             </div><!--end header-->
             <div id="menu-bar" class="menu-bar">
                    <ul class="menu-obj">
                         <li class="menu-obj-item"><a>Issue</a></li>
                         <li class="menu-obj-item"><a>Project</a></li>
                         <li class="menu-obj-item"><a>Status</a></li>
                    </ul>
             </div><!-- end menu-bar -->
             <div class="content">
                 <div class="table-container">
                      <table id="list"><tr><td></td></tr></table> 
                      <div id="pager"></div>
                 </div><!--end issue-table-->
             </div><!--end content-->
             <div class="footer">
                     <span>Copyright &copy Sergei Doroshenko</span>
             </div><!--end footer-->
        </div><!--end page-wrapper-->
             
      <!-------- Issue Template -------------->
      <div id="issue-template">
         <div class="issue-container">
               <div class="obj-fields">
                   <div id="id" class="obj-fields-item"><span>Id: </span></div>
                   <div id="createdate" class="obj-fields-item"><span>Create Date: </span></div>
                   <div id="createby" class="obj-fields-item"><span>Create By: </span></div>
                   <div id="modifydate" class="obj-fields-item"><span>Modify Date: </span></div>
                   <div id="modifyby" class="obj-fields-item"><span>Modified By: </span></div>
                   <div id="summary" class="obj-fields-item"><span>Summary: </span></div>
                   <div id="description" class="obj-fields-item"><span>Description: </span></div>
                   <div id="status" class="obj-fields-item"><span>Status: </span></div>
                   <div id="resolution" class="obj-fields-item"><span>Resolution: </span></div>
                   <div id="type" class="obj-fields-item"><span>Type: </span></div>
                   <div id="priority" class="obj-fields-item"><span>Priority: </span></div>
                   <div id="project" class="obj-fields-item"><span>Project: </span></div>
                   <div id="projectbuild" class="obj-fields-item"><span>Build found: </span></div>
                   <div id="assignee" class="obj-fields-item"><span>Assignee: </span></div>
               </div>
               <div class="com-att">
                   <div id="comment" class="comment">
                       <span class="field-label" >Comments: </span>
                       <div class="comments-container"></div>
                   </div><!-- comment end -->
               <div id="attachment" class="attachment">
                   <span class="field-label">Attachment: </span>
                   <div class="attachments-container"></div>
               </div><!-- attachment end -->
               </div><!-- isuue-container end -->
         </div>
      </div>
      <!-------- End of Issue Template -------------->
           <script type="text/javascript">
                   $( document ).ready(function () {
                           var searchString = window.location.search.substring(1);
                           var issueId = searchString.split('=')[1];
                           getIssue(issueId);        
                   });
                   
                   $('#auth-form').submit(function () {
                           console.log('You submit the form!');
                           var formdata = 'login=' + $('#login').val() + '&password=' + $('#password').val();
                           console.log(formdata);
                           var jqxhr = $.ajax({
                                   url: 'Login.do',
                                   data: formdata,
                                   type: 'get',
                                   success: function (data) {
                                           console.log('data=' + data);
                                           handleUserData(data);
                                           console.log('Status: ' + jqxhr.getAllResponseHeaders());
                                   },
                                   error: handleError
                           });
                           return false;
                   })
                   
                   function getIssue (id) {
                           $.ajax({
                           url: 'Issue.do',
                           data: 'issueId=' + id,
                           type: 'GET',
                           dataType : "json",                     
                           success: function (data, textStatus) {
                               $('.table-container').empty();
                               var templ = $('.issue-container').clone();
                               var issue = data.issue;
                               $(templ).find('#id').append('<span>' + issue.id + '</span>');
                               $(templ).find('#createdate').append(issue.createdate);
                               $(templ).find('#createby').append(issue.createby);
                               $(templ).find('#modifydate').append(issue.modifydate);
                               $(templ).find('#modifyby').append(issue.modifyby);
                               $(templ).find('#summary').append(issue.summary);
                               $(templ).find('#description').append(issue.description);
                               $(templ).find('#status').append(issue.status);
                               $(templ).find('#resolution').append(issue.resolution);
                               $(templ).find('#type').append(issue.type);
                               $(templ).find('#priority').append(issue.priority);
                               $(templ).find('#project').append(issue.project);
                               $(templ).find('#projectbuild').append(issue.projectbuild);
                               $(templ).find('#assignee').append(issue.assignee);
                               templ.appendTo('.content');
                               
                               var userdata = data.userdata;
                                   if('guest' != userdata.role) {
                                           handleUserData(userdata.name);
                                   } 
                               $('.menu-obj').empty().append('<li class="menu-obj-item"><a href="/issuetracker/">Main</a></li>');
                           },
                           error: function (response, status) {
                                   if(response.status == 400) {
                                           var errText = response.responseText;
                                           $('.table-container').empty().append('Error while getting url. ' + errText);     
                                   }
                           }
                       });
                   }
                   
                   function handleUserData (data) {
                           $("#auth-form").empty().append(data);
                           $("#auth-form:first").css("color", "white");
                           $('#error').empty();
                           $('<a>',{
                                   text:'log out',
                                   href:'Login.do',
                                   class: 'logout'
                           }).appendTo("#auth-form");
                   }
           </script>
     </body>
</html>